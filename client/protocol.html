<template name="protocol">
	<h1 data-bind="text: $root.editMode() ? id ? 'Edit protocol' : 'New protocol' : 'View protocol'"></h1>
	<div id="protocol">
		<h2 id="protocolName"><span data-bind="visible: !$root.editMode(), text: name"></span><input type="text" data-bind="visible: $root.editMode, value: name" /></h2>
		<div class="panel panel-default">
			<div class="panel-heading">	
				<h3 class="panel-title">Parameters&nbsp;&nbsp;<i class="glyphicon glyphicon-plus clickable" data-bind="visible: $root.editMode, click: addParam"></i></h3>
			</div>
			<ul class="list-group" id="protocolParameters" data-bind="foreach: params">
				<li class="list-group-item">
					<span data-bind="ifnot: $root.editMode">
						<a data-bind="text: type().name, attr: { href: '/t/' + type()._id() }"></a>:
						<span data-bind="text: name"></span>
						<span data-bind="if: multi">(multiple)</span>
					</span>
					<span class="input-group" data-bind="if: $root.editMode">
						<select style="width:45%;" class="form-control" data-bind="visible: $root.editMode, value: type, options: types(), optionsText: 'name'"></select>
						<input style="width:45%;" class="form-control" type="text" data-bind="value: name, valueUpdate: 'input', event: { change: nameChanged }" />
						<label class="form-control" style="width:10%;" ><input type="checkbox" data-bind="checked: multi" /> multiple</label>
						<i class="glyphicon glyphicon-trash clickable input-group-addon" data-bind="click: $parent.removeParam.bind($parent)"></i>
					</span>
				</li>
			</ul>
			
		</div>
		<div class="panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title" >Steps&nbsp;&nbsp;<i class="glyphicon glyphicon-plus clickable" data-bind="visible: $root.editMode, click: addStep"></i></h3>
			</div>
			<ol id="protocolSteps" class="list-group" data-bind="foreach: steps">
				<li class="list-group-item">
					<div class="stepDesc">
						<div data-bind="visible: !$root.editMode(), text: desc"></div>
						<div data-bind="if: $root.editMode">
							<input type="text" class="form-input" data-bind="value: desc" />
							<a href="" data-bind="click: $parent.removeStep.bind($parent)">-</a>
						</div>
					</div>
					<div class="stepUserInputs">
						User input fields: <a href="" data-bind="visible: $root.editMode, click: addInput">+</a>
						<ul data-bind="foreach: inputs">
							<li>
								<div data-bind="ifnot: $root.editMode">
									<span data-bind="text: desc"></span> (<span data-bind="text: type().desc"></span><span data-bind="if: multi">, prompted for every <span data-bind="text: multiParam().name"></span></span>)
								</div>
								<div data-bind="if: $root.editMode">
									<input type="text" data-bind="value: desc" />
									Type: <select data-bind="value: type, options: types, optionsText: 'desc'"></select>
									<input type="checkbox" data-bind="checked: multi" /> prompt for every <select data-bind="enable: multi, value: multiParam, options: $parents[1].multiParams, optionsText: 'name'"></select>
									<a href="" data-bind="click: $parent.removeInput.bind($parent)">-</a>
								</div>
							</li>
						</ul>
					</div>
				</li>
			</ol>
		</div>
		<div class="panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title">Products&nbsp;&nbsp;<i class="glyphicon glyphicon-plus clickable" data-bind="visible: $root.editMode, click: addProduct"></i></h3>
			</div>
			<ul class="list-group" id="protocolProducts" data-bind="foreach: products">
				<li class="list-group-item">
					Name: <span data-bind="visible: !$root.editMode(), text: name"></span><input type="text" data-bind="visible: $root.editMode, value: name" />
					<a href="" data-bind="visible: $root.editMode, click: $parent.removeProduct.bind($parent)">-</a>
					<br />
					Has the following type(s):
					<div data-bind="ifnot: $root.editMode">
						<ul data-bind="foreach: types">
							<li><a data-bind="text: name, attr: { href: '/t/' + _id() }"></a></li>
						</ul>
					</div>
					<select multiple="true" size="5" data-bind="visible: $root.editMode, options: possibleTypes, optionsText: 'name', selectedOptions: types"></select>
					<br />
					Property bindings:
					<ul data-bind="foreach: propertyBindings">
						<li>
							<span data-bind="text: property.name"></span> of type <span data-bind="text: property.from.name"></span> (<span data-bind="text: property.type"></span>):
							<span data-bind="visible: !$root.editMode(), text: source() &amp;&amp; source().text"></span><select data-bind="visible: $root.editMode, value: source, options: possibleSources, optionsText: 'text'"></select>
						</li>
					</ul>
				</li>
			</ul>
		</div>

		<button data-bind="visible: $root.editMode, click: save">Save</button>
		<div data-bind="ifnot: $root.editMode"><a data-bind="attr: { href: '/perform/' + id }">Perform this protocol</a></div>
	</div>
</template>
