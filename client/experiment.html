<template name="experiment">
	<h2 data-bind="text: $root.editMode() ? $root.newMode() ? 'Perform a protocol' : 'Edit experiment' : 'View experiment'"></h2>
	<div class="btn-toolbar pull-right" data-bind="if: !editMode()">
			<button class="btn btn-warning" data-bind="click: edit.bind($data), visible: !oldVersion"><span class="glyphicon glyphicon-pencil"></span> Edit</button>
			<button class="btn btn-info" data-bind="click: displayVersions.bind($data)"><span class="glyphicon glyphicon-time"></span> Versions</button>
	</div>
	<h1 data-bind="text: protocol.name"></h1>
	<p class="alert alert-info" data-bind="visible: oldVersion">You are viewing an old version of this experiment.</p>

	<p data-bind="ifnot: $root.editMode">Performed by <span data-bind="text: performer"></span></p>
	<input class="form-control" data-bind="visible: $root.editMode, value: performer" placeholder="Who are you?" />

	<table class="hierarchical">
		<tr data-bind="if: $root.editMode() &amp;&amp; $root.newMode()">
			<td><a href="" data-bind="click: addExperiment.bind($data)">+</a></td>
			<!-- ko foreach: experiments -->
				<td><a href="" data-bind="click: $parent.removeExperiment.bind($parent)">-</a></td>
			<!-- /ko -->
		</tr>
		<tr><th class="section" data-bind="attr: { colspan: colspan }"><h3>Parameters</h3></th></tr>
		<!-- ko foreach: protocol.params -->
			<tr>
				<th class="ul"><div class="li"><span data-bind="text: name"></span>:</div></th>
				<!-- ko if: multi -->
					<!--ko foreach: $root.experiments -->
						<td>
							<a href="" data-bind="visible: $root.editMode, click: addMultiParam.bind($data)($parent)">+</a>
							<ul data-bind="foreach: getParam($parent, true)">
								<li>
									<div data-bind="with: paramValue">
										<div data-bind="ifnot: $root.editMode() &amp;&amp; editable()">
											<a data-bind="text: text, attr: { href: href }"></a>
											<span data-bind="if: currentVersionHref">
												(<a data-bind="text: currentVersionText, attr: { href: currentVersionHref }"></a>)
											</span>
										</div>
										<div data-bind="if: $root.editMode() &amp;&amp; !editable()">
											<a href="" data-bind="click: edit.bind($data)">Edit</a>
										</div>
									</div>
									<div data-bind="if: $root.editMode() &amp;&amp; paramValue().editable()">
										<select class="form-control" data-bind="visible: $root.editMode, value: paramValue, options: $parent.possibleSources($parents[1]), optionsText: 'text'"></select>
										<a href="" data-bind="click: $parent.removeMultiParam($parents[1]).bind($parent)">-</a>
									</div>
								</li>
							</ul>
						</td>
					<!-- /ko -->
				<!-- /ko -->
				<!-- ko ifnot: multi -->
					<!--ko foreach: $root.experiments -->
						<td>
							<div data-bind="with: getParam($parent)">
								<div data-bind="ifnot: $root.editMode() &amp;&amp; editable()">
									<a data-bind="text: text, attr: { href: href }"></a>
									<span data-bind="if: currentVersionHref">
										(<a data-bind="text: currentVersionText, attr: { href: currentVersionHref }"></a>)
									</span>
								</div>
								<div data-bind="if: $root.editMode() &amp;&amp; !editable()">
									<a href="" data-bind="click: edit.bind($data)">Edit</a>
								</div>
							</div>
							<div data-bind="if: $root.editMode() &amp;&amp; getParam($parent)().editable()">
								<select class="form-control" data-bind="visible: $root.editMode, value: getParam($parent), options: 
								possibleSources($parent), optionsText: 'text'"></select>
							</div>
						</td>
					<!-- /ko -->
				<!-- /ko -->
			</tr>
		<!-- /ko -->
		<tr><th class="section" data-bind="attr: { colspan: colspan }"><h3>Steps</h3></th></tr>
		<!-- ko foreach: protocol.steps -->
			<tr><th class="ol" data-bind="attr: { colspan: $parent.colspan }"><div class="li" data-bind="text: desc"></div></th></tr>
			<!-- ko foreach: inputs -->
				<tr>
					<th class="ul indent1"><div class="li" data-bind="text: desc"></div></th>
					<!-- ko foreach: $root.experiments -->
						<td>
							<!-- ko if: $parent.multiParam -->
								<dl data-bind="foreach: params[$parent.multiParam]">
									<dt data-bind="text: paramValue().text"></dt>
									<dd>
										<span data-bind="visible: !$root.editMode(), text: input($parentContext.$parentContext.$parentContext.$index(), $parentContext.$parentContext.$index())"></span>
										<input type="text" class="form-control" data-bind="visible: $root.editMode, value: input($parentContext.$parentContext.$parentContext.$index(), $parentContext.$parentContext.$index())" />
									</dd>
								</dl>
							<!-- /ko -->
							<!-- ko ifnot: $parent.multiParam -->
								<span data-bind="visible: !$root.editMode(), text: input($parentContext.$parentContext.$index(), $parentContext.$index())"></span>
								<input type="text" class="form-control" data-bind="visible: $root.editMode, value: input($parentContext.$parentContext.$index(), $parentContext.$index())" />
							<!-- /ko -->
						</td>
					<!-- /ko -->
				</tr>
			<!-- /ko -->
		<!-- /ko -->
		<tr>
			<th><h3>Finished on</h3></th>
			<!-- ko foreach: $root.experiments -->
				<td>
					<div data-bind="visible: !$root.editMode(), text: UI._globalHelper('formatDate')(finishDate())"></div>
					<div class="form-inline datetime" data-bind="if: $root.editMode">
						<div class="datetime-date">
							<div class="input-group date" data-bind="datepicker: { date: finishDate, options: { todayBtn: 'linked', autoclose: true, todayHighlight: true } }, event: { 'change': function () { clearInterval(finishDateUpdate); } }">
								<input class="form-control" type="text" />
								<span class="input-group-addon">
									<span class="glyphicon glyphicon-calendar"></span>
								</span>
							</div>
						</div>
						<div class="datetime-time">
							<div class="input-group time" data-bind="clockpicker: finishDate, event: { 'change': function () { clearInterval(finishDateUpdate); } }">
								<input type="text" class="form-control" />
								<span class="input-group-addon">
									<span class="glyphicon glyphicon-time"></span>
								</span>
							</div>
						</div>
					</div>
				</td>
			<!-- /ko -->
		</tr>
		<tr>
			<th><h3>Notes</h3></th>
			<!-- ko foreach: $root.experiments -->
				<td>
					<p data-bind="visible: !$root.editMode(), text: notes"></p>
					<textarea class="form-control" data-bind="visible: $root.editMode, value: notes"></textarea>
				</td>
			<!-- /ko -->
		</tr>
	</table>

	<div class="btn-toolbar">
		<button class="btn btn-success" data-bind="visible: $root.editMode, click: save.bind($data)">Save</button>
		<button class="btn btn-danger" data-bind="visible: $root.editMode, click: cancel.bind($data)">Cancel</button>
	</div>

	<div id="versionsModal" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<h4 class="modal-title">Version Management</h4>
				</div>
				<div class="modal-body">
					<div class="list-group" data-bind="foreach: versions" >
						<a class="list-group-item" data-bind="text: 'Version '+ (versionNr +1), attr: { href: href }, css: { 'active': isCurrent($parent.version)},click: hideModal"></a>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
</template>
